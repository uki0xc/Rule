name: Fetch Specific Rules Daily

on:
  schedule:
    - cron: '0 19 * * *'  # UTC+8 (北京时间凌晨3点)
  workflow_dispatch:

jobs:
  fetch-and-integrate-rules:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout current repository
        uses: actions/checkout@v4

      - name: Create Rule directory
        run: mkdir -p Rule

      - name: Fetch and Integrate Intelligence Rules
        run: |
          echo "# Intelligence Rules - Fetched on $(TZ=Asia/Shanghai date +'%Y-%m-%d %H:%M:%S GMT+8')" > Rule/Intelligence.list
          echo "" >> Rule/Intelligence.list

          {
            curl -sL https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Surge/OpenAI/OpenAI.list
            curl -sL https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Surge/Gemini/Gemini.list
            curl -sL https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Surge/Claude/Claude.list
            curl -sL https://raw.githubusercontent.com/EAlyce/conf/refs/heads/main/Rule/OpenAI.list
            echo "DOMAIN-KEYWORD,apple-relay"
          } | grep -v '^#' | sort | uniq >> Rule/Intelligence.list

      - name: Fetch and Integrate CN Rules
        run: |
          echo "# CN Rules - Fetched on $(TZ=Asia/Shanghai date +'%Y-%m-%d %H:%M:%S GMT+8')" > Rule/CN.list
          echo "" >> Rule/CN.list

          {
            curl -sL https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Surge/ChinaMax/ChinaMax_All.list
            curl -sL https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Surge/MeiTuan/MeiTuan.list
            curl -sL https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Surge/WeChat/WeChat.list
            echo "DOMAIN-SUFFIX,example.cn"
          } | grep -v '^#' | sort | uniq >> Rule/CN.list

      - name: Fetch and Format Google Rules
        run: |
          echo "# Google Rules - Fetched on $(TZ=Asia/Shanghai date +'%Y-%m-%d %H:%M:%S GMT+8')" > Rule/Google.list
          echo "" >> Rule/Google.list
          curl -sL https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/refs/heads/master/rule/Surge/Google/Google.list | grep -v '^#' | sort | uniq >> Rule/Google.list

      - name: Fetch and Format X (Twitter) Rules
        run: |
          echo "# X Rules - Fetched on $(TZ=Asia/Shanghai date +'%Y-%m-%d %H:%M:%S GMT+8')" > Rule/X.list
          echo "" >> Rule/X.list
          curl -sL https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/refs/heads/master/rule/Surge/Twitter/Twitter.list | grep -v '^#' | sort | uniq >> Rule/X.list

      - name: Fetch and Format Github Rules
        run: |
          echo "# Github Rules - Fetched on $(TZ=Asia/Shanghai date +'%Y-%m-%d %H:%M:%S GMT+8')" > Rule/Github.list
          echo "" >> Rule/Github.list
          curl -sL https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/refs/heads/master/rule/Surge/GitHub/GitHub.list | grep -v '^#' | sort | uniq >> Rule/Github.list

      - name: Fetch and Format FuckAds Rules
        run: |
          echo "# FuckAds Rules - Fetched on $(TZ=Asia/Shanghai date +'%Y-%m-%d %H:%M:%S GMT+8')" > Rule/FuckAds.list
          echo "" >> Rule/FuckAds.list
          curl -sL https://raw.githubusercontent.com/fmz200/wool_scripts/refs/heads/main/Loon/rule/rejectAd.list | grep -v '^#' | sort | uniq >> Rule/FuckAds.list

      - name: Fetch and Format Spotify Rules
        run: |
          echo "# Spotify Rules - Fetched on $(TZ=Asia/Shanghai date +'%Y-%m-%d %H:%M:%S GMT+8')" > Rule/Spotify.list
          echo "" >> Rule/Spotify.list
          curl -sL https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/refs/heads/master/rule/Surge/Spotify/Spotify.list | grep -v '^#' | sort | uniq >> Rule/Spotify.list

      - name: Commit and push changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

          git add Rule/Intelligence.list Rule/CN.list Rule/Google.list Rule/X.list Rule/Github.list Rule/FuckAds.list Rule/Spotify.list
          if git diff --staged --quiet; then
            echo "No changes to commit for rule lists in Rule/."
          else
            COMMIT_TIME=$(TZ=Asia/Shanghai date +'%Y-%m-%d %H:%M:%S GMT+8')
            git commit -m "Update rule lists - $COMMIT_TIME"
            git push
          fi
